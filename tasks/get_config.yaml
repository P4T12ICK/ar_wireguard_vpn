---
- name: Check if client configuration files exist
  ansible.builtin.stat:
    path: "{{ vpn_clients_dir }}/{{ item.name }}.conf"
  register: client_config_files
  loop: "{{ vpn_clients }}"
  when: vpn_clients_dir is defined and vpn_clients | length > 0
  changed_when: false

- name: Download client configuration files to local filesystem
  ansible.builtin.fetch:
    src: "{{ vpn_clients_dir }}/{{ item.name }}.conf"
    dest: "{{ client_config_local_dir | default('client_configs') }}/{{ item.name }}.conf"
    flat: true
  loop: "{{ vpn_clients }}"
  when:
    - vpn_clients_dir is defined
    - vpn_clients | length > 0
    - item.name is defined
  register: fetched_configs
  failed_when: false

- name: Display download status
  ansible.builtin.debug:
    msg: |
      Client: {{ item.item.name }}
      Status: {{ 'Downloaded' if item.dest | default('') != '' else 'Not found' }}
      Local path: {{ item.dest | default('N/A') }}
  loop: "{{ fetched_configs.results | default([]) }}"
  when: vpn_clients_dir is defined and vpn_clients | length > 0

- name: Warn if client configs not found
  ansible.builtin.debug:
    msg: "Client configuration file not found for {{ item.item.name }}"
  loop: "{{ fetched_configs.results | default([]) }}"
  when:
    - item.dest is not defined or item.dest == ''
